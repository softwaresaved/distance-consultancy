Distance for Windows and R
==========================

Analysis engines:

* MRDS fits detection functions to point and line transect distance sampling survey data
* DSM fits density surface models to spatially-referenced distance sampling data

Distance for Windows <=> R interface
------------------------------------

* Create input files.
* Invoke R e.g.:

<p/>

    C:\PROGRA~1\R\rw1091\bin\Rcmd.exe BATCH C:\temp\dst90474\in.r C:\temp\dst90474\log.r

* Wait for results
* Read results

Input files
-----------

* `in.r` - R commands
* `ddf.dat.r` - data used in detection function modelling
* `region.dat.r`
* `sample.dat.r`
* `obs.dat.r`
* Above three files are used in estimating density given a fitted detection function

Mapping Distance field names to covariate names
-----------------------------------------------

* Not a 1:1 correspondence due to limitations of R and MRDS implementation
* Names are converted to lower case
* Non-alphanumeric characters are replaced by `.`
* Names that don't start with `a-z` are prefixed with `X`
* Fields with specific roles are translated:

| Field name             | Covariate name |
| ---------------------- | -------------- |
| Perpendicular distance | distance       |
| Cluster size           | size           |
| Object                 | object         |
| Observer               | observer       |
| Detected               | detected       |

* Use field names as-is if unique
* If non-unique:
  - For lowest layer can use field name as-is
  - Prefix higher layers with `LAYERTYPE.` e.g. `stratum.`, `global.`

Distance for Windows project folder
-----------------------------------

* Optional `R` folder within `.dat` folder
* `.RData` - R object file
  - Objects created during analysis, virtually empty unless debugging or logging
* `prefix.analysis ID.plot number.suffix` - image files (optional):
  - `.wmf`,(default), `.jpeg`, `.bmp`

User-configurable settings
--------------------------

* Folder containing R
* Properties of images generated by R
* Remove new objects that are created with each run - keeps `.RData` compact
* Remove objects not associated with analyses in project after each run
  - If above is un-ticked
  - Garbage collects old objects in `.RData` or image files
* Re-install analysis engine libraries to original versions on next run
  - Reinstall R libraries from archive in `Distance 6\RPackages`
* Update dependencies from CRAN on next run (requires web access)
  - Search CRAN for updated libraries and update if found

Update R packages:

* Copy new `mrds.zip` or `dsm.zip` into `Distance 6\RPackages`

How to capture input files
--------------------------

* Select Tools => Preferences...
* Click Analysis tab
* Check Debug mode (create command files but don't run engine)
* Check `Temp` directory

If reusing files elsewhere check to ensure that any paths within the files are updated.

How to run stand-alone
----------------------

Within R GUI:

* Cut and paste `in.r` commands

Within R batch mode e.g.

    Rcmd.exe BATCH in.r log.r

CDS and MCDS analysis engine <=> R
-----------------------------------

From Exporting CDS Results from Analysis Details Results, user's guide, p115:

* Paste the data from the clipboard to a text file e.g. `plot.txt`
* Paste the following into R:

<p/>

    #this reads in the file just created
    forplot<-read.table(file="plot.txt", header=T, sep="\t", dec=".")
    #note, depending on your language, dec might be "," rather than "."
    #this plots the detection function or pdf (if point transects)
    plot(forplot$C1, forplot$C2, type="l", ylim=c(0,max(forplot$C4)),
    xlab="Distance", ylab="Detection probability")
    #Define labels as you wish
    #this adds in the data bars
    lines(c(0,0), c(forplot$C3[1], forplot$C4[1]))
    lines(forplot$C3, forplot$C4)
    The following code can be used to recreate qq-plots:
    #this reads in the file just created
    forplot<-read.table(file="plot.txt", header=T, sep="\t", dec=".")
    #note, depending on your language, dec might be "," rather than "."
    #this plots the detection function or pdf (if point transects)
    plot(forplot$C1, forplot$C2, type="p", ylim=c(0,max(forplot$C4)),
    pch = ".", xlab="Empirical distribution function",
    ylab="Fitted cumulative distribution function")
    #Define labels as you wish
    #this adds in the (0,0) (1,1) line
    lines(c(0,1), c(0,1))

From Exporting MCDS Results, user's guide, p144:

* As above then:

<p/>

    #this reads in the file just created
    forplot<-read.table(file="plot.txt", header=T, sep="\t", dec=".")
    #note, depending on your language, dec might be "," rather than "."
    #this plots the detection function or pdf (if point transects)
    plot(forplot$C1, forplot$C2, type="l", ylim=c(0,1),
    xlab="Distance", ylab="Detection probability")
    #Define labels as you wish
    #this adds in other two lines
    lines(forplot$C3, forplot$C4, lty=2)
    lines(forplot$C5, forplot$C6, lty=3)

Implementation
--------------

Random numbers:

* R default - see `help(.Random.Seed)`

MRDS main functions:

* `ddf()` - fits detection function
* `dht()` - estimates abundance using Hortvitz-Thompson-like estimator

DSM main functions:

* `dsm()` - fitsdensity surface model
* `predict.dsm()` - produces estimated response across prediction grid
