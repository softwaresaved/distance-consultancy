---
layout: page
root: ..
title: Distance for Windows and R
---

Analysis engines:

* MRDS fits detection functions to point and line transect distance sampling survey data
* DSM fits density surface models to spatially-referenced distance sampling data

Distance for Windows <=> R interface
====================================

* Create input files.
* Invoke R e.g.:

<p/>

    C:\PROGRA~1\R\rw1091\bin\Rcmd.exe BATCH C:\temp\dst90474\in.r C:\temp\dst90474\log.r

* Wait for results
* Read results

See Visual Basic <=> R interface below for more details.

Input files
-----------

* in.r - R commands
* ddf.dat.r - data used in detection function modelling
* region.dat.r
* sample.dat.r
* obs.dat.r
* Above three files are used in estimating density given a fitted detection function

Mapping Distance field names to covariate names
-----------------------------------------------

* Not a 1:1 correspondence due to limitations of R and MRDS implementation
* Names are converted to lower case
* Non-alphanumeric characters are replaced by '.'
* Names that don't start with a-z are prefixed with X
* Fields with specific roles are translated:

| Field name             | Covariate name |
| ---------------------- | -------------- |
| Perpendicular distance | distance       |
| Cluster size           | size           |
| Object                 | object         |
| Observer               | observer       |
| Detected               | detected       |

* Use field names as-is if unique
* If non-unique:
  - For lowest layer can use field name as-is
  - Prefix higher layers with LAYERTYPE. e.g. stratum., global.

Distance for Windows project folder
-----------------------------------

* Optional R folder within .dat folder
* .RData - R object file
  - Objects created during analysis, virtually empty unless debugging or logging
* prefix.analysis ID.plot number.suffix - image files (optional):
  - .wmf,(default), .jpeg, .bmp

User-configurable settings
--------------------------

* Folder containing R
* Properties of images generated by R
* Remove new objects that are created with each run - keeps .RData compact
* Remove objects not associated with analyses in project after each run
  - If above is un-ticked
  - Garbage collects old objects in .RData or image files
* Re-install analysis engine libraries to original versions on next run
  - Reinstall R libraries from archive in Distance 6\RPackages
* Update dependencies from CRAN on next run (requires web access)
  - Search CRAN for updated libraries and update if found

Update R packages:

* Copy new mrds.zip or dsm.zip into Distance 6\RPackages

How to capture input files
--------------------------

* Select Tools => Preferences...
* Click Analysis tab
* Check Debug mode (create command files but don't run engine)
* Check Temp directory

If reusing files elsewhere check to ensure that any paths within the files are updated.

How to run stand-alone
----------------------

Within R GUI:

* Cut and paste in.r commands

Within R batch mode e.g.

    Rcmd.exe BATCH in.r log.r

CDS and MCDS analysis engine <=> R
-----------------------------------

From Exporting CDS Results from Analysis Details Results, user's guide, p115:

* Paste the data from the clipboard to a text file e.g. plot.txt
* Paste the following into R:

<p/>

    #this reads in the file just created
    forplot<-read.table(file="plot.txt", header=T, sep="\t", dec=".")
    #note, depending on your language, dec might be "," rather than "."
    #this plots the detection function or pdf (if point transects)
    plot(forplot$C1, forplot$C2, type="l", ylim=c(0,max(forplot$C4)),
    xlab="Distance", ylab="Detection probability")
    #Define labels as you wish
    #this adds in the data bars
    lines(c(0,0), c(forplot$C3[1], forplot$C4[1]))
    lines(forplot$C3, forplot$C4)
    The following code can be used to recreate qq-plots:
    #this reads in the file just created
    forplot<-read.table(file="plot.txt", header=T, sep="\t", dec=".")
    #note, depending on your language, dec might be "," rather than "."
    #this plots the detection function or pdf (if point transects)
    plot(forplot$C1, forplot$C2, type="p", ylim=c(0,max(forplot$C4)),
    pch = ".", xlab="Empirical distribution function",
    ylab="Fitted cumulative distribution function")
    #Define labels as you wish
    #this adds in the (0,0) (1,1) line
    lines(c(0,1), c(0,1))

From Exporting MCDS Results, user's guide, p144:

* As above then:

<p/>

    #this reads in the file just created
    forplot<-read.table(file="plot.txt", header=T, sep="\t", dec=".")
    #note, depending on your language, dec might be "," rather than "."
    #this plots the detection function or pdf (if point transects)
    plot(forplot$C1, forplot$C2, type="l", ylim=c(0,1),
    xlab="Distance", ylab="Detection probability")
    #Define labels as you wish
    #this adds in other two lines
    lines(forplot$C3, forplot$C4, lty=2)
    lines(forplot$C5, forplot$C6, lty=3)

Visual Basic <=> R interface
============================

Microsoft Jet database, DistIni.mdb, settings:

* Table: ProjectSettingsMemo
* Section: AnalysisEngine
* Field: Setting - value ';' delimited entries of form 'Name=Value'
* Entries of note are as follows:

| Key | PackageName | SupportFileName | PrgProgId | EngIntProgId | LogPropId | ResProgId | 
| --- | ----------- | --------------- | --------- | ------------ | --------- | --------- |
| DSM | dsm | dsm.support.r | D6DSMPrp.DSMProperties | D6DSMNEI.DSMNEngineInterface | D6DSMDet.DSMLog;Log | D6DSMDet.DSMResults
| MRDS | mrds | mrds.support.r | D6MRDSPrp.MRDSProperties | D6MRDSNEI.MRDSNEngineInterface | D6MRDSDet.MRDSLog | D6MRDSDet.MRDSResults |

* Table: ProjectSettingsBoolean
* Section: R
* Keys: ForceLoadLibrary, UpdateFromCRAN

Analysis Engines\DSM\NEngineInterface\Classes\InputFileMaker.cls:

* Function Makefile 
  - Creates DSM input files
* Function AppendLinkDSMLibraryString:
  - Calls D6NEIUtil.GetRSupportFileName("") to get R support file name
  - Calls D6NEIUtil.GetRSupportFileName("DSM") to get DSM R support file name
  - Gets database, ProjectSettingsBoolean table, R section, value for Key="ForceLoadLibrary"
  - Gets database, ProjectSettingsBoolean table, R section, value for Key="UpdateFromCRAN"
  - If selected, CRAN updates are done using http://cran.r-project.org
  - Calls D6NEIUtil.GetRPackageName("DSM") DSM R package name
  - Calls D6NEIUtil.GetRPackagePath to get package path

Analysis Engines\DSM\NEngineInterface\Classes\DSMNEngineInterface.cls:

* Function RunItem:
  - Calls RProcess.EngineName to get engine file name
  - Calls RProcess.RunEngine(engine file name, current directory, input file, log file)

Analysis Engines\Shared Stuff\NEngineInterfaceUtilities\Classes\RProcess.cls

* Property Get EngineName
  - Invokes GetEngineName as a property
* Function GetEngineName:
  - Gets database, ProjectSettingsMemo table, R section, value for Key=Path
  - If not found then gets D6Util.GetRInstallPath and sets database value
  - Adds executable name, gstrRCMD, to path
* Sub RunEngine
  - Invokes `PATH\bin\i386\Rcmd.exe" gstrBATCH INPUT_FILE LOG_FILE`

Analysis Engines\Shared Stuff\NEngineInterfaceUtilities\Classes\InputFileMakerUtils.cls:

* Function GetRPackageName:
  - Gets database, ProjectSettingsMemo table, AnalysisEngine section, Setting value for Key=="DSM"|"MRDS" and parses Name=Value pairs in Setting value to get PackageName
  - Returns full path to ZIP file or package name only depending on boolean argument
* Function GetRPackagePath:
  - Calls D6Util.RPath to convert App.Path\RPackages\ to R-compliant format
* Function GetRSupportFileName
  - If argument Key=="" then file name is set to getstrR_SUPPORT_FILE
  - Else gets database, ProjectSettingsMemo table, AnalysisEngine section, Setting value for Key=="DSM"|"MRDS" and parses Name=Value pairs in Setting value to get SupportFileName
  - Returns file name prefixed with App.Path\ depending on boolean argument

Analysis Engines\Shared Stuff\NEngineInterfaceUtilities\Modules\Global.bas:

* Global Const gstrR_SUPPORT_FILE = "support.r"
* Global Const gstrRCMD = "\bin\i386\Rcmd.exe"
* Global Const gstrBATCH = "BATCH"

Utilities\Classes\StringHandling.cls:

* Function RPath
  - Returns string with '\' replaced by '\\\'

Utilities\Classes\Misc.cls:

* Function GetRInstallPath
  - Searches Windows registry for R path
  - Get value of HKEY_LOCAL_MACHINE\Software\R-core\R\Current Version
  - If found, get value of HKEY_LOCAL_MACHINE\Software\R-core\R\CURRENT_VERSION\InstallPath
  - Else get value of HKEY_CURRENT_USER\Software\R-core\R\Current Version
  - If found, get value of HKEY_CURRENT_USER\Software\R-core\R\CURRENT_VERSION\InstallPath
  - Else, for older R versions, get value of HKEY_LOCAL_MACHINE\Software\R-core\R\Current Version
  - If found, get value of HKEY_LOCAL_MACHINE, Software\R-core\R\InstallPath

MRDS is similar.

Miscellaneous DSM and MRDS implementation details
=================================================

Random numbers:

* R default - see help(.Random.Seed)

MRDS main functions:

* ddf() - fits detection function
* dht() - estimates abundance using Hortvitz-Thompson-like estimator

DSM main functions:

* dsm() - fitsdensity surface model
* predict.dsm() - produces estimated response across prediction grid
